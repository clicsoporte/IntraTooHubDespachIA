# Plan de Reconstrucción Post-Rollback a v2.0.0

Este documento sirve como guía maestra para re-implementar de forma ordenada y estable las funcionalidades clave que se desarrollaron después de la versión 2.0.0, basándonos en la versión estable de `git`.

---

## 1. Módulo: Gestor de Notificaciones y Tareas Programadas (Cron)

### 1.1. Objetivo
La versión antigua ya contaba con el icono de la campana y notificaciones básicas. Lo que se debe reconstruir es el **módulo de administración** que permite una configuración avanzada.

### 1.2. Requisitos de UI
- **Página de Automatización (`/admin/notifications`):**
    - Una interfaz con dos pestañas: "Reglas de Notificación" y "Tareas Programadas".
    - **Reglas:** Permite crear una regla que se dispara por un evento del sistema (ej: 'onDispatchCompleted') y ejecuta una acción (ej: 'sendEmail'). Debe permitir configurar destinatarios, asunto, etc.
    - **Tareas:** Permite crear una tarea que se ejecuta en un horario cron (ej: `0 2 * * *`), selecciona una acción predefinida del sistema (ej: `sync-erp`) y la activa o desactiva.
- **Página de Configuración de Servicios (`/admin/notifications/settings`):**
    - Un formulario para guardar credenciales de servicios externos, específicamente para el bot de **Telegram** (Bot Token y Chat ID).

### 1.3. Lógica y Flujo
- **Registro de Tareas (`task-registry.ts`):** Un archivo central donde se definen las funciones que pueden ser llamadas por el cron (ej: `syncAllData`).
- **Motor de Cron (`cron-runner.ts`):** Un script que se inicia con el servidor, lee las tareas activas de la base de datos y las programa usando `node-cron`.
- **Motor de Eventos (`notifications-engine.ts`):** Una función `triggerNotificationEvent` que, al ser llamada desde cualquier parte del código, busca reglas que coincidan con el evento y ejecuta la acción correspondiente (enviar correo, telegram, etc.).
- **Nuevas Tablas en `notifications.db`:**
    - `notification_rules`: Para guardar las reglas de notificación.
    - `scheduled_tasks`: Para guardar las tareas cron.
    - `notification_settings`: Para guardar credenciales de servicios como Telegram.

---

## 2. Módulo: Centro de Despacho (FUNCIONALIDAD MAYOR)

Este es el módulo más grande y crítico a reconstruir. Digitaliza todo el proceso de alistamiento y verificación de mercadería.

### 2.1. Parte A: Configuración y Clasificación

- **Nuevas Tablas en `warehouse.db`:**
    - `dispatch_containers`: Para las rutas/contenedores (ej: "Ruta San José").
    - `dispatch_assignments`: Para asociar facturas a contenedores.
    - `dispatch_logs`: Para auditar cada verificación.
- **Página de Configuración (`/admin/warehouse`):** Añadir una sección para crear y eliminar `dispatch_containers`.
- **Página del Clasificador (`/warehouse/dispatch-classifier`):**
    - Una vista con dos pestañas: "Asignar" y "Ordenar".
    - **Pestaña "Asignar":** Filtro de fechas para buscar facturas/remisiones del ERP que no han sido asignadas. Permite selección masiva y asignación a un contenedor.
    - **Pestaña "Ordenar":** Vista de columnas (una por contenedor) que permite arrastrar y soltar (`drag-and-drop`) las facturas para definir el orden de entrega. Debe mostrar una alerta visual si una factura fue anulada.

### 2.2. Parte B: Flujo de Verificación del Bodeguero

- **Página del Centro de Despacho (`/warehouse/dispatch-center`):**
    - Muestra tarjetas para cada contenedor. Al hacer clic, se debe **bloquear** el contenedor para ese usuario, evitando que dos personas trabajen en la misma ruta.
    - Dentro, muestra la lista ordenada de documentos.
- **Página de Verificación (`/warehouse/dispatch-check`):**
    - La interfaz principal de escaneo. Muestra la lista de artículos de la factura.
    - Un `Input` para escanear códigos de barras que incrementa la cantidad del artículo correcto.
    - Al finalizar, guarda el `dispatch_log` y navega automáticamente al siguiente documento del contenedor si existe.

### 2.3. Parte C: Reporte de Despachos

- **Nueva Página (`/analytics/dispatch-report`):**
    - Este reporte **no existe** en la versión antigua y debe ser creado.
    - Debe permitir auditar todas las verificaciones, con filtros por fecha y búsqueda.
    - Debe mostrar quién verificó qué documento, cuándo, y permitir ver el detalle de los artículos con sus discrepancias.

---

## 3. Módulo: Corrección de Ingresos (Almacén)

### 3.1. Objetivo
Crear una herramienta de "cuchillo suizo" para que un supervisor pueda corregir un error común: registrar un producto con un código incorrecto durante la recepción de mercadería.

### 3.2. Requisitos
- **Nueva Página (`/warehouse/correction`):**
    - Una interfaz para **buscar** una unidad de inventario (`InventoryUnit`) por varios criterios (fecha, lote, producto, etc.).
    - Una tabla con los resultados, donde cada fila tiene un botón "Corregir".
- **Modal de Corrección:**
    - Al hacer clic en "Corregir", se abre un `Dialog`.
    - Muestra la información de la unidad original.
    - Proporciona un `SearchInput` para buscar y seleccionar el **producto correcto**.
    - Incluye una advertencia clara sobre la irreversibilidad de la acción y requiere confirmación.
- **Acción del Servidor (`correctInventoryUnit`):**
    - Debe ejecutar una transacción en `warehouse.db` que:
        1. Anula la `InventoryUnit` original (ej. cantidad a 0).
        2. Registra un movimiento de inventario de **salida** para el producto incorrecto.
        3. Crea una **nueva** `InventoryUnit` con los datos originales pero con el **ID del producto correcto**.
        4. Registra un movimiento de inventario de **entrada** para el producto correcto.
        5. Registra todo el evento en la tabla de `logs` para auditoría.

---
**Nota Final:** Después del `rollback`, revisa el archivo `src/modules/core/lib/data.ts` y asegúrate de que los `ToolCard` para estos nuevos módulos (`dispatch-report`, `correction`) estén añadidos a las listas `analyticsTools` y `warehouseTools` con sus respectivos permisos para que aparezcan en el panel.
