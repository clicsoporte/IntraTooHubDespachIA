# Lluvia de Ideas: Módulo de Gestión de Horarios y Planillas (Recursos Humanos)
v1.0

## 1. Objetivo Principal
Crear un módulo de RH que importe marcas de un reloj de tiempo (SQL Server), las cruce con datos del ERP (empleados, planillas, departamentos) y calcule las horas trabajadas (ordinarias, extras, dobles) según las reglas específicas de la empresa y la legislación de Costa Rica, para generar un pre-reporte de planilla.

## 2. Arquitectura y Fuentes de Datos

*   **Nueva Conexión a Base de Datos:**
    *   Añadir en `Administración > Importar Datos` una nueva sección para configurar la conexión a una **segunda base de datos SQL Server**: la del sistema de marcas de tiempo.
    *   Esto requerirá una nueva tabla de configuración (ej: `time_clock_sql_config`) en `intratool.db` y expandir la lógica del servicio SQL.
*   **Sincronización de Marcas:**
    *   Crear una nueva tabla interna (ej: `time_clock_entries`) para almacenar las marcas importadas.
    *   La importación traerá el ID del empleado y la fecha/hora de la marca (entrada o salida).
*   **Integración con Datos Existentes:** El módulo utilizará los datos ya sincronizados desde el ERP principal: Empleados, Departamentos y Planillas (Nóminas).

## 3. Configuración del Módulo (Desde el Panel de Administración)

Será crucial crear una nueva sección en **Administración** con varios paneles para configurar las reglas de negocio:

*   **Panel de Gestión de Jornadas:**
    *   Crear, editar y eliminar tipos de jornadas (ej: "Acumulativa Diurna", "Ordinaria Nocturna", "Administrativa").
    *   Para cada jornada, definir:
        *   **Tipo:** Acumulativa o Ordinaria.
        *   **Horas Semanales Base:** (ej: 48).
        *   **Parámetros Acumulativos (si aplica):**
            *   Horas ordinarias diarias objetivo (ej: 9.6).
            *   Horas extra diarias objetivo (ej: 2.4).
            *   Reglas de reducción por ausencia (ej: -1 día = base 40h, -2 días = base 38.4h).
    *   Asignar jornadas a **Departamentos** o **Planillas (Nóminas)** como configuración por defecto.

*   **Panel de Gestión de Horarios:**
    *   Definir los horarios de trabajo (ej: "Turno A Diurno", "Turno B Nocturno", "Horario Oficina").
    *   Para cada horario, asociarle una **Jornada** de la lista anterior.
    *   Establecer la hora de entrada y salida estándar.

*   **Panel de Reglas de redondeo de Marcas ("Tolerancias"):**
    *   Crear reglas de redondeo asignables por departamento.
    *   Ejemplo: Regla "Producción"
        *   **Tolerancia de Entrada:** 4 minutos.
        *   **Lógica de Castigo:** Si marca entre el minuto 5 y 30, redondear a la siguiente media hora (ej: 6:05 -> 6:30).
        *   **Contador de Tolerancia:** Días de gracia antes de aplicar castigo (ej: 2).
    *   Ejemplo: Regla "Administración"
        *   **Tolerancia de Entrada:** 10 minutos.
        *   **Lógica de Castigo:** Ninguna.

*   **Panel de Configuración de Empleados Especiales:**
    *   Una interfaz para marcar empleados con "Horario Flexible" o "Permiso para Horas Extra", que los excluiría de ciertas reglas de redondeo o les permitiría acumular tiempo extra automáticamente.

## 4. Flujo de Trabajo y Lógica del Módulo

1.  **Asignación Empleado-Horario:** En la ficha de cada empleado (o en un nuevo panel de RH), se deberá asignar un **Horario** específico (que a su vez tiene una **Jornada** asociada).
2.  **Procesador de Horas (El "Motor" del Módulo):**
    *   Una nueva herramienta principal, "Procesador de Planilla" o "Cálculo de Horas".
    *   El usuario seleccionará un rango de fechas y una planilla o departamento.
    *   **Paso 1 (Importar):** El sistema descarga las marcas del reloj para los empleados seleccionados.
    *   **Paso 2 (Limpiar y Redondear):** Aplica las reglas de redondeo y tolerancia a las marcas de entrada/salida según el departamento del empleado.
    *   **Paso 3 (Calcular Horas Brutas):** Para cada día, calcula el total de horas trabajadas.
    *   **Paso 4 (Aplicar Lógica de Jornada):**
        *   Consulta la jornada del empleado (a través de su horario).
        *   **Si es Ordinaria:** Simplemente calcula horas ordinarias y extra según el horario estándar.
        *   **Si es Acumulativa:**
            *   Verifica si en la semana hubo feriados, vacaciones, permisos o incapacidades para ese empleado. Si es así, **suspende la lógica acumulativa** para esa semana y calcula como si fuera jornada ordinaria.
            *   Si no hay excepciones, aplica las reglas de acumulación (ej: 9.6h ordinarias, el resto extra).
            *   Considera las reglas de ausencias para ajustar la base de horas ordinarias.
    *   **Paso 5 (Manejo de Fines de Semana y Feriados):**
        *   Identifica las horas trabajadas en sábados, domingos o feriados.
        *   **Alerta de Aprobación:** Si un empleado de jornada acumulativa trabaja un fin de semana pero tuvo ausencias, el sistema mostrará una alerta visual en esa línea: "Extras de fin de semana pendientes de aprobación". Se necesitará un botón de "Aprobar" para que esas horas se sumen como extra.
    *   **Paso 6 (Aprobación de Horas Extra):** Para los empleados que no tienen permiso automático de horas extra, si marcan salida después de su hora, esas horas aparecerán en una columna "Extra por Aprobar" con un botón para que un supervisor las apruebe.

## 5. Interfaz de Usuario (Vista Principal del Módulo)

*   Una tabla potente y con filtros por fecha, empleado, departamento y planilla.
*   **Columnas Clave:** Empleado, Fecha, Horario, Marca Entrada, Marca Salida (original), Entrada Calculada, Salida Calculada, Horas Ordinarias, Horas Extra, Horas Extra Aprobadas, Horas Dobles, Excepciones (Vacaciones, Incapacidad), Aprobación de Extras (botón).
*   **Resumen por Empleado:** Tarjetas o filas de resumen que totalicen las horas por tipo para el período seleccionado.
*   **Exportación:** Botones para exportar la vista filtrada a Excel, generando el archivo necesario para el sistema de planillas.
